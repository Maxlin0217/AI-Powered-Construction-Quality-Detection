<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ä¸Šå¥½ç‰Œç ‚æ¼¿ AI æ™ºèƒ½æ–½å·¥è³ªé‡æª¢æ¸¬ç³»çµ±">
    <meta name="theme-color" content="#ED1C24">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>ä¸Šå¥½ç‰Œæ–½å·¥æ™ºèƒ½æª¢æ¸¬</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", Arial, sans-serif;
        }
        
        body {
            background: #e8e8e8;
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
        }
        
        /* åŒ…è£è¢‹ä¸»å®¹å™¨ - æ¨¡æ“¬ç«‹é«”è¢‹å­ */
        .package-container {
            max-width: 500px;
            margin: 20px auto;
            background: white;
            position: relative;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.3),
                inset 0 0 0 1px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        /* åŒ…è£è¢‹é ‚éƒ¨å°å£æ•ˆæœ */
        .package-top {
            background: linear-gradient(to bottom, #f5f5f5 0%, white 100%);
            padding: 15px 20px 10px;
            position: relative;
            border-bottom: 2px solid #ddd;
        }
        
        .package-top::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: repeating-linear-gradient(
                90deg,
                #ddd 0px,
                #ddd 10px,
                transparent 10px,
                transparent 20px
            );
        }
        
        /* é ‚éƒ¨ç´…è‰²æ¨™èª - æ¨¡æ“¬å°åˆ· - æ¯›ç­†æ›¸æ³•å­—é«” */
        .top-slogan {
            text-align: right;
            color: #ED1C24;
            font-size: 20px;
            font-weight: 900;
            letter-spacing: 5px;
            transform: rotate(-2deg);
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            font-family: "DFKai-SB", "æ¨™æ¥·é«”", "BiauKai", "Kaiti TC", "KaiTi", "æ¥·ä½“", cursive, serif;
        }
        
        /* å°èˆªæŒ‰éˆ• - ç½®æ–¼é ‚éƒ¨å›ºå®šä½ç½® */
        .nav-overlay {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            gap: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .nav-btn {
            background: white;
            border: 2px solid #ED1C24;
            color: #ED1C24;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .nav-btn:hover {
            background: #ED1C24;
            color: white;
        }
        
        /* ä¸»è¦Logoå€åŸŸ - æ”¹ç‚ºç™½è‰²èƒŒæ™¯ */
        .brand-section {
            background: white;
            padding: 40px 20px;
            position: relative;
            overflow: hidden;
        }
        
        /* å·¦ä¸Šè§’è£é£¾åœ–æ¡ˆ - éš±è— */
        .corner-logo {
            display: none;
        }
        
        /* ä¸­å¤®ç™½è‰²Logoæ¡† - ç²¾ç¢ºé‚„åŸ */
        .brand-box {
            background: white;
            margin: 0 auto;
            max-width: 320px;
            border-radius: 3px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .brand-chinese {
            font-size: 56px;
            font-weight: 900;
            color: white;
            letter-spacing: 8px;
            line-height: 1;
            margin: 0;
            padding: 35px 20px 20px;
            background: #ED1C24;
        }
        
        .brand-divider {
            width: 100%;
            height: 4px;
            background: #ED1C24;
            margin: 0;
        }
        
        .brand-english {
            font-size: 32px;
            font-weight: bold;
            color: #1a1a1a;
            letter-spacing: 10px;
            line-height: 1;
            margin: 0;
            padding: 20px 20px 30px;
            background: white;
        }
        
        /* å´é‚Šæ¢ç´‹ - é©æ‡‰ç™½è‰²èƒŒæ™¯ */
        .side-stripe-left,
        .side-stripe-right {
            position: absolute;
            top: 0;
            width: 25px;
            height: 100%;
            background: linear-gradient(to right, 
                rgba(0, 0, 0, 0.05) 0%,
                transparent 50%,
                rgba(0, 0, 0, 0.02) 100%
            );
        }
        
        .side-stripe-left {
            left: 0;
        }
        
        .side-stripe-right {
            right: 0;
            background: linear-gradient(to left, 
                rgba(0, 0, 0, 0.05) 0%,
                transparent 50%,
                rgba(0, 0, 0, 0.02) 100%
            );
        }
        
        /* é»‘è‰²ç”¢å“åç¨±å€ - ç²¾ç¢ºé‚„åŸ */
        .product-name-section {
            background: #2b2b2b;
            padding: 30px 20px;
            text-align: center;
            position: relative;
        }
        
        .product-main-title {
            font-size: 36px;
            font-weight: 900;
            color: white;
            letter-spacing: 12px;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .product-sub-title {
            font-size: 22px;
            font-weight: bold;
            color: white;
            letter-spacing: 6px;
            opacity: 0.95;
        }
        
        /* ç”¢å“è¦æ ¼å€ - æ¨¡æ“¬åŒ…è£è¢‹åº•éƒ¨ç™½è‰²å€åŸŸ */
        .specs-section {
            background: white;
            padding: 30px 20px;
            border-top: 1px solid #ddd;
            text-align: center;
        }
        
        .specs-main {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .specs-weight {
            font-size: 28px;
            font-weight: 900;
            color: #1a1a1a;
            margin: 8px 0;
        }
        
        .specs-cert {
            font-size: 13px;
            color: #666;
            line-height: 2;
            margin-top: 5px;
        }
        
        /* ç”¢å“ç…§ç‰‡å±•ç¤º */
        .product-display {
            background: linear-gradient(135deg, #f9f9f9 0%, #e8e8e8 100%);
            padding: 40px 20px;
            text-align: center;
        }
        
        .product-image {
            max-width: 180px;
            height: auto;
            filter: drop-shadow(0 15px 35px rgba(0, 0, 0, 0.3));
            transition: transform 0.3s;
        }
        
        .product-image:hover {
            transform: scale(1.05) rotate(2deg);
        }
        
        /* å…§å®¹å€åŸŸ */
        .content-area {
            padding: 30px 20px;
            background: white;
        }
        
        .card {
            background: #fafafa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .card-highlight {
            border-color: #ED1C24;
            border-width: 3px;
            background: white;
        }
        
        .phase-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .phase-btn {
            background: white;
            border: 2px solid #ED1C24;
            padding: 18px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .phase-btn:hover {
            background: #fff5f5;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(237, 28, 36, 0.25);
        }
        
        .phase-btn.selected {
            background: #ED1C24;
            color: white;
            box-shadow: 0 6px 20px rgba(237, 28, 36, 0.4);
        }
        
        .phase-title {
            font-size: 17px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .phase-desc {
            font-size: 13px;
            line-height: 1.4;
            opacity: 0.85;
        }
        
        .phase-risks {
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            font-size: 12px;
        }
        
        .phase-btn.selected .phase-risks {
            border-top-color: rgba(255, 255, 255, 0.3);
        }
        
        .risk-tag {
            display: inline-block;
            background: #2b2b2b;
            color: white;
            padding: 3px 10px;
            border-radius: 3px;
            margin: 3px;
            font-size: 11px;
        }
        
        .phase-btn.selected .risk-tag {
            background: rgba(0, 0, 0, 0.3);
        }
        
        .btn {
            background: #ED1C24;
            color: white;
            border: none;
            padding: 18px 35px;
            border-radius: 5px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
            letter-spacing: 3px;
            text-transform: uppercase;
        }
        
        .btn:hover { 
            background: #c71820;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(237, 28, 36, 0.4);
        }
        
        .btn:disabled {
            background: #999;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .btn-black {
            background: #2b2b2b;
        }
        
        .btn-black:hover {
            background: #1a1a1a;
        }
        
        .btn-outline {
            background: white;
            color: #ED1C24;
            border: 3px solid #ED1C24;
        }
        
        .btn-outline:hover {
            background: #ED1C24;
            color: white;
        }
        
        .success {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 18px 25px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        
        .warning {
            background: linear-gradient(135deg, #FFC107, #ffb300);
            color: #333;
            padding: 18px 25px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        }
        
        .info {
            background: #f5f5f5;
            border-left: 5px solid #ED1C24;
            padding: 18px 25px;
            margin-top: 20px;
            font-size: 14px;
            line-height: 1.8;
        }
        
        .step-title {
            font-size: 26px;
            font-weight: 900;
            margin-bottom: 20px;
            color: #ED1C24;
            letter-spacing: 3px;
            border-left: 6px solid #ED1C24;
            padding-left: 18px;
        }
        
        img, canvas {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 3px solid #e0e0e0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .result-item {
            background: white;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 6px solid #ED1C24;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }
        
        .defect-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .defect-name {
            font-size: 24px;
            font-weight: 900;
            color: #ED1C24;
            letter-spacing: 2px;
        }
        
        .badge {
            background: #2b2b2b;
            color: white;
            padding: 8px 18px;
            border-radius: 5px;
            font-size: 15px;
            font-weight: bold;
        }
        
        .defect-info {
            background: #fafafa;
            padding: 25px;
            border-radius: 8px;
            margin-top: 15px;
            line-height: 1.9;
            border: 2px solid #f0f0f0;
        }
        
        .defect-section {
            margin-top: 18px;
        }
        
        .defect-section-title {
            color: #ED1C24;
            font-weight: 900;
            margin-bottom: 10px;
            font-size: 17px;
            letter-spacing: 1px;
        }
        
        input[type="file"] {
            display: none;
        }
        
        /* åº•éƒ¨åŒ…è£å°å£æ•ˆæœ */
        .package-bottom {
            background: linear-gradient(to top, #f5f5f5 0%, white 100%);
            padding: 20px;
            border-top: 2px solid #ddd;
            position: relative;
        }
        
        .package-bottom::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: repeating-linear-gradient(
                90deg,
                #ddd 0px,
                #ddd 10px,
                transparent 10px,
                transparent 20px
            );
        }
        
        /* Loading å‹•ç•« */
        .loading {
            text-align: center;
            padding: 50px 20px;
            color: #ED1C24;
            font-weight: bold;
            font-size: 18px;
        }
        
        .loading::after {
            content: "â³";
            font-size: 56px;
            display: block;
            margin-top: 20px;
            animation: spin 2s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .package-container {
                margin: 10px;
                border-radius: 5px;
            }
            
            .nav-overlay {
                flex-direction: column;
                gap: 5px;
                padding: 8px;
            }
            
            .nav-btn {
                font-size: 12px;
                padding: 6px 15px;
            }
            
            .brand-chinese {
                font-size: 46px;
                letter-spacing: 6px;
            }
            
            .brand-english {
                font-size: 26px;
                letter-spacing: 8px;
            }
            
            .product-main-title {
                font-size: 28px;
                letter-spacing: 8px;
            }
            
            .product-sub-title {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <!-- æµ®å‹•å°èˆªæŒ‰éˆ• -->
    <div class="nav-overlay">
        <a href="index.html" class="nav-btn">ğŸ  é¦–é </a>
        <a href="https://www.mfgroup.com.tw/product.php?lang=tw&tb=3" class="nav-btn" target="_blank">ğŸŒ å®˜ç¶²</a>
    </div>
    
    <!-- åŒ…è£è¢‹ä¸»å®¹å™¨ -->
    <div class="package-container">
        <!-- åŒ…è£è¢‹é ‚éƒ¨å°å£ -->
        <div class="package-top">
            <div class="top-slogan">ä¸Šå¥½åç”¨ä¸Šå¥½æ–™</div>
        </div>
        
        <!-- ä¸»è¦ç´…è‰²å“ç‰Œå€ -->
        <div class="brand-section">
            <!-- å·¦ä¸Šè§’è£é£¾ -->
            <div class="corner-logo">ä¸Š</div>
            
            <!-- å´é‚Šæ¢ç´‹æ•ˆæœ -->
            <div class="side-stripe-left"></div>
            <div class="side-stripe-right"></div>
            
            <!-- ä¸­å¤®ç™½è‰²Logoæ¡† -->
            <div class="brand-box">
                <div class="brand-chinese">ä¸Šå¥½ç‰Œ</div>
                <div class="brand-divider"></div>
                <div class="brand-english">SUNHOW</div>
            </div>
        </div>
        
        <!-- é»‘è‰²ç”¢å“åç¨±å€ -->
        <div class="product-name-section">
            <div class="product-main-title">æ–½å·¥æ™ºèƒ½æª¢æ¸¬</div>
            <div class="product-sub-title">AI DETECTION</div>
        </div>
        
        <!-- ç”¢å“è¦æ ¼å€ -->
        <div class="specs-section">
            <div class="specs-cert">
                ISO 9001èªè­‰<br>
                CNSèªè­‰ç”¢å“<br>
                ä¹¾æ‹Œç ‚æ¼¿å°ˆæ¥­è£½é€ 
            </div>
        </div>
        
        <!-- ç”¢å“å±•ç¤º -->
        <div class="product-display">
            <img src="product.jpg" alt="ä¸Šå¥½ç‰Œç ‚æ¼¿" class="product-image">
        </div>
        
        <!-- å…§å®¹å€åŸŸ -->
        <div class="content-area">
            <div id="app">
                <div class="card card-highlight">
                    <div class="loading">
                        ç³»çµ±å•Ÿå‹•ä¸­
                    </div>
                </div>
            </div>
        </div>
        
        <!-- åŒ…è£è¢‹åº•éƒ¨å°å£ -->
        <div class="package-bottom">
            <div style="text-align: center; color: #666; font-size: 13px; line-height: 1.8;">
                <strong style="color: #ED1C24; font-size: 16px;">ä¸Šå¥½ç‰Œ SUNHOW</strong><br>
                å“è³ªä¿è­‰ Â· å€¼å¾—ä¿¡è³´<br>
                æ–½å·¥æ™ºèƒ½æª¢æ¸¬ç³»çµ±
            </div>
        </div>
    </div>

    <script>
        let session = null;
        let currentImage = null;
        let selectedPhase = null;
        
        const INPUT_SIZE = 640;
        const CONFIDENCE_THRESHOLD = 0.25;
        const IOU_THRESHOLD = 0.45;
        
        const classNames = [
            'Crack', 'Efflorescence', 'Rebar', 'Rust', 'Scaling', 'Spall', 'Spallingw',
            'Hollowing', 'Bad_corner', 'Sandy_surface', 'Honeycomb'
        ];
        
        const classNamesChinese = {
            'Crack': 'è£‚ç¸«',
            'Efflorescence': 'ç™½è¯',
            'Rebar': 'é‹¼ç­‹å¤–éœ²',
            'Rust': 'é½è•',
            'Scaling': 'å‰è½',
            'Spall': 'å‰é›¢',
            'Spallingw': 'å‰é›¢Wå‹',
            'Hollowing': 'ç©ºé¼“',
            'Bad_corner': 'é™°é™½è§’ä¸é †ç›´',
            'Sandy_surface': 'è¡¨é¢ç²—ç³™/èµ·ç ‚',
            'Honeycomb': 'èœ‚çª©'
        };
        
        const constructionPhases = {
            'base': { name: 'åŸºå±¤è™•ç†', description: 'æ¸…ç†åŸºå±¤ã€æ¾†æ°´æ¿•æ½¤ã€å¡—åˆ·ç•Œé¢åŠ‘', risks: ['ç©ºé¼“', 'å‰é›¢'] },
            'datum': { name: 'åŠå‚ç·šã€åšç°é¤…', description: 'å½ˆç·šå®šä½ã€è¨­ç½®ç°é¤…ã€è¨­ç½®æ²–ç­‹', risks: ['é™°é™½è§’ä¸é †ç›´'] },
            'corner': { name: 'è­·è§’æ–½å·¥', description: 'å®‰è£è­·è§’æ¢ã€åŠ è¨­åŠ å¼·ç¶²', risks: ['è£‚ç¸«', 'é™°é™½è§’ä¸é †ç›´'] },
            'base_plaster': { name: 'åº•å±¤æŠ¹ç°', description: 'ç”©æ¼¿ã€æŠ¹åº•ç°ï¼ˆ5-7mmï¼‰', risks: ['ç©ºé¼“', 'è£‚ç¸«'] },
            'middle_plaster': { name: 'ä¸­å±¤æŠ¹ç°', description: 'æŠ¹ä¸­å±¤ï¼ˆ8-10mmï¼‰ã€æ“å¹³', risks: ['è£‚ç¸«', 'è¡¨é¢ç²—ç³™'] },
            'finish_plaster': { name: 'é¢å±¤æŠ¹ç°', description: 'æŠ¹é¢å±¤ï¼ˆ2-3mmï¼‰ã€å£“å…‰', risks: ['è¡¨é¢ç²—ç³™/èµ·ç ‚', 'ç™½è¯'] },
            'curing': { name: 'é¤Šè­·éšæ®µ', description: 'å™´æ°´é¤Šè­·ï¼ŒæŒçºŒ â‰¥ 7 å¤©', risks: ['è£‚ç¸«', 'èµ·ç ‚'] },
            'final': { name: 'æˆå“é©—æ”¶', description: 'å…¨é¢æª¢æŸ¥è³ªé‡', risks: ['æ‰€æœ‰ç¼ºé™·é¡å‹'] }
        };
        
        const expertAdvice = {
            'Crack': {
                description: 'è¡¨é¢ç´°å°æˆ–æ˜é¡¯çš„è£‚ç¸«ï¼Œå¯èƒ½ç‚ºä¹¾ç¸®è£‚ç¸«æˆ–çµæ§‹è£‚ç¸«',
                causes: 'ç ‚æ¼¿é…æ¯”æ°´æ³¥éå¤šã€æŠ¹ç°å¤ªåšæœªåˆ†å±¤ã€ç•°è³ªææ–™äº¤æ¥è™•æœªåŠ å¼·',
                solutions: ['ç‰†æ ¹ã€äº¤æ¥è™•åŠ è¨­ 300mm å¯¬åŠ å¼·ç¶²', 'åš´æ ¼åŸ·è¡Œåˆ†å±¤æŠ¹ç°ï¼Œå–®å±¤åšåº¦ < 9mm', 'ä½¿ç”¨ä¸Šå¥½ç‰Œå°ˆæ¥­ç ‚æ¼¿'],
                prevention: 'äº¤æ¥è™•æ›ç¶²ã€åš´æ ¼æ§åˆ¶åšåº¦ã€å……åˆ†é¤Šè­·'
            },
            'Hollowing': {
                description: 'ç‰†é¢å±€éƒ¨é¼“èµ·ã€é¾œè£‚ï¼Œåš´é‡æ™‚å‡ºç¾å¡Šç‹€è„«è½',
                causes: 'åŸºå±¤æ¸…ç†ä¸æ·¨ã€æœªæå‰æ¾†æ°´æ¿•æ½¤ã€ç”©æ¼¿å¼·åº¦ä¸è¶³',
                solutions: ['æ•²é™¤ç©ºé¼“å€åŸŸï¼Œå¾¹åº•æ¸…ç†åŸºå±¤', 'åˆ·ä¸€é“å«å»ºç¯‰è† çš„ç´ æ°´æ³¥æ¼¿', 'ä½¿ç”¨ä¸Šå¥½ç‰Œç ‚æ¼¿é‡æ–°åˆ†å±¤æŠ¹ç°'],
                prevention: 'åŸºå±¤æ¸…ç†å¾¹åº•ã€æ¾†æ°´å……åˆ†ã€ç”©æ¼¿åˆ°ä½'
            },
            'Bad_corner': {
                description: 'ç‰†è§’é‚Šç·šä¸ç›´ã€æ­ªæ–œï¼Œç”¨æ–¹å°ºæª¢æŸ¥ä¸æ–¹æ­£',
                causes: 'æœªåšç°é¤…ã€æ²–ç­‹æ‰¾è¦çŸ©ã€æœªä½¿ç”¨å°ˆç”¨é™°é™½è§’æŠ¹å­',
                solutions: ['æŠ¹ç°å‰å¿…é ˆå½ˆåå­—ç·šã€åšç°é¤…', 'ä½¿ç”¨é•·é å°ºèˆ‡å°ˆç”¨æŠ¹å­ä¸Šä¸‹æŠ½å¹³', 'åš´é‡è®Šå½¢éœ€é‡æ–°æ–½ä½œ'],
                prevention: 'ç²¾ç¢ºæ”¾ç·šã€ç°é¤…æ²–ç­‹åˆ°ä½ã€ä½¿ç”¨å°ˆç”¨å·¥å…·'
            },
            'Sandy_surface': {
                description: 'ç‰†é¢è‰²æ¾¤ä¸å‡ã€æ¥æ§æ˜é¡¯ï¼Œè¡¨é¢é¬†æ•£æ˜“æ‰ç ‚',
                causes: 'é¤Šè­·ä¸è¶³å¤±æ°´éå¿«ã€ä½¿ç”¨éæ™‚ç°ã€å£“å…‰æ™‚é–“ä¸ç•¶',
                solutions: ['æŠ¹ç°å¾Œ 12 å°æ™‚å…§é–‹å§‹å™´æ°´é¤Šè­·', 'åš´ç¦ä½¿ç”¨è¶…é 3 å°æ™‚çš„ã€Œéæ™‚ç°ã€', 'é¸ç”¨ä¸Šå¥½ç‰Œé«˜å“è³ªç ‚æ¼¿'],
                prevention: 'å£“å…‰æ™‚æ©Ÿæ­£ç¢ºã€å……åˆ†é¤Šè­·ã€ä½¿ç”¨æ–°é®®ç ‚æ¼¿'
            },
            'Efflorescence': {
                description: 'ç‰†é¢å‡ºç¾ç™½è‰²çµæ™¶ç‰©ï¼ˆé¹½æç¾è±¡ï¼‰',
                causes: 'æ°´æ³¥æˆ–ç ‚ä¸­å«å¯æº¶æ€§é¹½é¡ã€é¤Šè­·æœŸéåº¦æ½®æ¿•',
                solutions: ['ç”¨ç¨€é¹½é…¸æ¸…æ´—ä¸¦å……åˆ†æ²–æ°´', 'é¸ç”¨ä¸Šå¥½ç‰Œä½é¹¼æ°´æ³¥ç ‚æ¼¿', 'åŠ å¼·é˜²æ°´æªæ–½'],
                prevention: 'é¸ç”¨ä½é¹¼æ°´æ³¥ã€æ§åˆ¶é¤Šè­·æ¿•åº¦ã€åšå¥½é˜²æ°´'
            },
            'Rebar': {
                description: 'é‹¼ç­‹å¤–éœ²ï¼Œä¿è­·å±¤ä¸è¶³',
                causes: 'ä¿è­·å±¤åšåº¦ä¸è¶³ã€æ··å‡åœŸå‰è½',
                solutions: ['æ¸…ç†é½è•ï¼Œå¡—åˆ·é˜²é½åŠ‘', 'ä½¿ç”¨é«˜å¼·åº¦ä¿®è£œç ‚æ¼¿ä¿®å¾©', 'åš´é‡æ™‚éœ€çµæ§‹è£œå¼·'],
                prevention: 'ç¢ºä¿ä¿è­·å±¤åšåº¦ã€åšå¥½é˜²æ°´'
            },
            'Rust': {
                description: 'é‹¼ç­‹é½è•ï¼Œè¡¨é¢å‡ºç¾é½æ–‘',
                causes: 'ä¿è­·å±¤ç ´æã€é•·æœŸæ½®æ¿•ç’°å¢ƒ',
                solutions: ['æ¸…é™¤é½è•è‡³é‡‘å±¬å…‰æ¾¤', 'å¡—åˆ·é˜²é½åº•æ¼†', 'ä¿®å¾©ä¿è­·å±¤ä¸¦é˜²æ°´'],
                prevention: 'ä¿è­·å±¤å®Œæ•´ã€é˜²æ°´åˆ°ä½ã€å®šæœŸæª¢æŸ¥'
            },
            'Scaling': {
                description: 'è¡¨é¢å±¤ç‹€å‰è½',
                causes: 'åŸºå±¤è™•ç†ä¸ç•¶ã€ææ–™é…æ¯”å•é¡Œ',
                solutions: ['æ¸…é™¤å‰è½éƒ¨ä½', 'é‡æ–°æ–½ä½œä¸¦åŠ å¼·é¤Šè­·', 'ä½¿ç”¨ä¸Šå¥½ç‰Œå°ˆæ¥­ç ‚æ¼¿'],
                prevention: 'åŸºå±¤è™•ç†åˆ°ä½ã€é¸ç”¨å„ªè³ªææ–™'
            },
            'Spall': {
                description: 'æ··å‡åœŸå¡Šç‹€å‰é›¢',
                causes: 'å‡èæå®³ã€é‹¼ç­‹é½è„¹ã€è¡æ“Šæå‚·',
                solutions: ['è©•ä¼°çµæ§‹å®‰å…¨', 'ä½¿ç”¨èšåˆç‰©ç ‚æ¼¿ä¿®è£œ', 'å¿…è¦æ™‚é€²è¡Œçµæ§‹è£œå¼·'],
                prevention: 'é˜²å‡èã€é˜²é½è•ã€é¿å…è¡æ“Š'
            },
            'Spallingw': {
                description: 'Wå‹å‰é›¢ç ´æ',
                causes: 'æ‡‰åŠ›é›†ä¸­ã€ææ–™åŠ£åŒ–',
                solutions: ['å°ˆæ¥­çµæ§‹è©•ä¼°', 'æŒ‰è¦ç¯„é€²è¡Œä¿®å¾©', 'ç›£æ¸¬å¾ŒçºŒç™¼å±•'],
                prevention: 'çµæ§‹è¨­è¨ˆåˆç†ã€ææ–™å“è³ªå„ªè‰¯'
            },
            'Honeycomb': {
                description: 'è¡¨é¢å‘ˆç¾èœ‚çª©ç‹€å­”æ´',
                causes: 'æŒ¯æ—ä¸å¯¦ã€æ¼æŒ¯ã€é…æ¯”ä¸ç•¶',
                solutions: ['è©•ä¼°æ·±åº¦å’Œç¯„åœ', 'ä½¿ç”¨é«˜æµå‹•æ€§ä¿®è£œæ–™å¡«å……', 'åš´é‡æ™‚éœ€é‘¿é™¤é‡åš'],
                prevention: 'å……åˆ†æŒ¯æ—ã€é…æ¯”æº–ç¢ºã€æ–½å·¥è¦ç¯„'
            }
        };
        
        function tryLoadORT() {
            const localScript = document.createElement('script');
            localScript.src = './ort.min.js';
            localScript.onload = () => { console.log('âœ… æœ¬åœ°è¼‰å…¥'); checkORT(); };
            localScript.onerror = () => { console.log('å˜—è©¦ CDN'); tryLoadFromCDN(); };
            document.head.appendChild(localScript);
        }
        
        function tryLoadFromCDN() {
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/onnxruntime-web@1.19.2/dist/ort.min.js';
            script.onload = () => { console.log('âœ… CDN è¼‰å…¥'); checkORT(); };
            script.onerror = () => { console.error('âŒ è¼‰å…¥å¤±æ•—'); showOfflineInstructions(); };
            document.head.appendChild(script);
        }
        
        function checkORT() {
            if (typeof ort !== 'undefined') { console.log('âœ… æº–å‚™å°±ç·’'); autoLoadModel(); }
            else { setTimeout(checkORT, 100); }
        }
        
        function showOfflineInstructions() {
            document.getElementById('app').innerHTML = `
                <div class="card"><div class="warning">âš ï¸ ç„¡æ³•è¼‰å…¥ç³»çµ±<br><small>è«‹ç¢ºä¿é€šéä¼ºæœå™¨è¨ªå•</small></div>
                <button class="btn" onclick="location.reload()">ğŸ”„ é‡æ–°è¼‰å…¥</button></div>`;
        }
        
        async function autoLoadModel() {
            const app = document.getElementById('app');
            app.innerHTML = `<div class="card card-highlight"><div class="loading">è¼‰å…¥ AI æ¨¡å‹ä¸­</div></div>`;
            try {
                const response = await fetch('best.onnx');
                if (!response.ok) throw new Error('æ¨¡å‹æª”æ¡ˆä¸å­˜åœ¨');
                const arrayBuffer = await response.arrayBuffer();
                session = await ort.InferenceSession.create(arrayBuffer);
                console.log('âœ… æ¨¡å‹è¼‰å…¥æˆåŠŸ');
                showPhaseSelection();
            } catch (err) {
                console.error('è¼‰å…¥å¤±æ•—:', err);
                showManualUpload();
            }
        }
        
        function showManualUpload() {
            const app = document.getElementById('app');
            app.innerHTML = `<div class="card"><div class="warning">âš ï¸ ç„¡æ³•è‡ªå‹•è¼‰å…¥æ¨¡å‹</div>
                <div class="step-title">æ‰‹å‹•ä¸Šå‚³æ¨¡å‹</div>
                <button class="btn" onclick="selectModel()">ğŸ“¤ é¸æ“‡ best.onnx</button>
                <input type="file" id="modelInput" accept=".onnx" onchange="loadModel(this)"></div>`;
        }
        
        function selectModel() { document.getElementById('modelInput').click(); }
        
        async function loadModel(input) {
            const file = input.files[0];
            if (!file) return;
            const app = document.getElementById('app');
            app.innerHTML = `<div class="card card-highlight"><div class="loading">è¼‰å…¥ä¸­</div></div>`;
            try {
                const arrayBuffer = await file.arrayBuffer();
                session = await ort.InferenceSession.create(arrayBuffer);
                showPhaseSelection();
            } catch (err) {
                app.innerHTML = `<div class="card"><div class="warning">âŒ è¼‰å…¥å¤±æ•—ï¼š${err.message}</div>
                    <button class="btn" onclick="showManualUpload()">ğŸ”„ é‡è©¦</button></div>`;
            }
        }
        
        function showPhaseSelection() {
            const app = document.getElementById('app');
            let phasesHTML = '';
            for (const [key, phase] of Object.entries(constructionPhases)) {
                const risksHTML = phase.risks.map(risk => `<span class="risk-tag">${risk}</span>`).join('');
                phasesHTML += `<div class="phase-btn" onclick="selectPhase('${key}')">
                    <div class="phase-title">${phase.name}</div>
                    <div class="phase-desc">${phase.description}</div>
                    <div class="phase-risks"><strong>å¸¸è¦‹é¢¨éšªï¼š</strong><br>${risksHTML}</div></div>`;
            }
            app.innerHTML = `<div class="success">âœ… ç³»çµ±å·²å°±ç·’</div>
                <div class="card card-highlight"><div class="step-title">æ­¥é©Ÿ 1ï¼šé¸æ“‡æ–½å·¥éšæ®µ</div>
                <div class="phase-selector">${phasesHTML}</div>
                <button class="btn btn-outline" onclick="skipPhaseSelection()">â­ï¸ è·³éï¼ˆé€šç”¨æª¢æ¸¬ï¼‰</button></div>`;
        }
        
        function selectPhase(phaseKey) {
            selectedPhase = phaseKey;
            document.querySelectorAll('.phase-btn').forEach(btn => btn.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            setTimeout(() => showImageUpload(), 500);
        }
        
        function skipPhaseSelection() { selectedPhase = null; showImageUpload(); }
        
        function showImageUpload() {
            const app = document.getElementById('app');
            let phaseWarning = '';
            if (selectedPhase) {
                const phase = constructionPhases[selectedPhase];
                phaseWarning = `<div class="warning"><strong>âš ï¸ æœ¬éšæ®µé‡é»æª¢æ¸¬ï¼š</strong>${phase.risks.join('ã€')}</div>`;
            }
            app.innerHTML = `<div class="success">âœ… æº–å‚™å°±ç·’</div>${phaseWarning}
                <div class="card card-highlight"><div class="step-title">æ­¥é©Ÿ 2ï¼šä¸Šå‚³ç…§ç‰‡</div>
                <button class="btn" onclick="selectImage()">ğŸ“· é¸æ“‡ç…§ç‰‡</button>
                <input type="file" id="imageInput" accept="image/*" onchange="loadImage(this)">
                <div class="info">ğŸ’¡ å»ºè­°ï¼šä½¿ç”¨æ¸…æ™°ç…§ç‰‡ï¼Œç¢ºä¿ç¼ºé™·éƒ¨ä½æ¸…æ¥šå¯è¦‹</div></div>`;
        }
        
        function selectImage() { document.getElementById('imageInput').click(); }
        
        function loadImage(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) { currentImage = e.target.result; showImagePreview(); };
            reader.readAsDataURL(file);
        }
        
        function showImagePreview() {
            const app = document.getElementById('app');
            app.innerHTML = `<div class="success">âœ… ç…§ç‰‡å·²è¼‰å…¥</div><div class="card"><img src="${currentImage}">
                <button class="btn" onclick="runDetection()">ğŸ¯ é–‹å§‹æª¢æ¸¬</button>
                <button class="btn btn-outline" onclick="showImageUpload()" style="margin-top: 10px;">ğŸ“· é‡é¸ç…§ç‰‡</button></div>`;
        }
        
        async function runDetection() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'â³ æª¢æ¸¬ä¸­...';
            try {
                const img = new Image();
                img.src = currentImage;
                await new Promise(resolve => img.onload = resolve);
                const input = await preprocessImage(img);
                const feeds = {};
                feeds[session.inputNames[0]] = input;
                const results = await session.run(feeds);
                const detections = postprocess(results[session.outputNames[0]], img.width, img.height);
                showResults(img, detections);
            } catch (err) {
                console.error('æª¢æ¸¬éŒ¯èª¤:', err);
                document.getElementById('app').innerHTML = `<div class="card"><div class="warning">âŒ æª¢æ¸¬å¤±æ•—ï¼š${err.message}</div>
                    <button class="btn" onclick="showImagePreview()">ğŸ”„ é‡è©¦</button></div>`;
            }
        }
        
        async function preprocessImage(img) {
            const canvas = document.createElement('canvas');
            canvas.width = INPUT_SIZE;
            canvas.height = INPUT_SIZE;
            const ctx = canvas.getContext('2d');
            const scale = Math.min(INPUT_SIZE / img.width, INPUT_SIZE / img.height);
            const scaledWidth = img.width * scale;
            const scaledHeight = img.height * scale;
            const x = (INPUT_SIZE - scaledWidth) / 2;
            const y = (INPUT_SIZE - scaledHeight) / 2;
            ctx.fillStyle = '#114';
            ctx.fillRect(0, 0, INPUT_SIZE, INPUT_SIZE);
            ctx.drawImage(img, x, y, scaledWidth, scaledHeight);
            const imageData = ctx.getImageData(0, 0, INPUT_SIZE, INPUT_SIZE);
            const pixels = imageData.data;
            const red = [], green = [], blue = [];
            for (let i = 0; i < pixels.length; i += 4) {
                red.push(pixels[i] / 255);
                green.push(pixels[i + 1] / 255);
                blue.push(pixels[i + 2] / 255);
            }
            const input = Float32Array.from([...red, ...green, ...blue]);
            return new ort.Tensor('float32', input, [1, 3, INPUT_SIZE, INPUT_SIZE]);
        }
        
        function postprocess(output, imgWidth, imgHeight) {
            const data = output.data;
            const dims = output.dims;
            const numClasses = classNames.length;
            const numBoxes = dims[2] || dims[1];
            const boxes = [];
            const scale = Math.min(INPUT_SIZE / imgWidth, INPUT_SIZE / imgHeight);
            for (let i = 0; i < numBoxes; i++) {
                let maxScore = 0;
                let maxClass = 0;
                for (let c = 0; c < numClasses; c++) {
                    const score = data[i + (4 + c) * numBoxes];
                    if (score > maxScore) { maxScore = score; maxClass = c; }
                }
                if (maxScore < CONFIDENCE_THRESHOLD) continue;
                const x = data[i];
                const y = data[i + numBoxes];
                const w = data[i + 2 * numBoxes];
                const h = data[i + 3 * numBoxes];
                const x1 = ((x - w / 2) - (INPUT_SIZE - imgWidth * scale) / 2) / scale;
                const y1 = ((y - h / 2) - (INPUT_SIZE - imgHeight * scale) / 2) / scale;
                const x2 = ((x + w / 2) - (INPUT_SIZE - imgWidth * scale) / 2) / scale;
                const y2 = ((y + h / 2) - (INPUT_SIZE - imgHeight * scale) / 2) / scale;
                boxes.push({
                    x1, y1, x2, y2, score: maxScore, class: maxClass,
                    className: classNames[maxClass], chineseName: classNamesChinese[classNames[maxClass]]
                });
            }
            return nms(boxes, IOU_THRESHOLD);
        }
        
        function nms(boxes, iouThreshold) {
            boxes.sort((a, b) => b.score - a.score);
            const keep = [];
            while (boxes.length > 0) {
                keep.push(boxes[0]);
                boxes = boxes.slice(1).filter(box => {
                    const iou = calculateIOU(keep[keep.length - 1], box);
                    return iou < iouThreshold;
                });
            }
            return keep;
        }
        
        function calculateIOU(box1, box2) {
            const x1 = Math.max(box1.x1, box2.x1);
            const y1 = Math.max(box1.y1, box2.y1);
            const x2 = Math.min(box1.x2, box2.x2);
            const y2 = Math.min(box1.y2, box2.y2);
            const intersection = Math.max(0, x2 - x1) * Math.max(0, y2 - y1);
            const area1 = (box1.x2 - box1.x1) * (box1.y2 - box1.y1);
            const area2 = (box2.x2 - box2.x1) * (box2.y2 - box2.y1);
            const union = area1 + area2 - intersection;
            return intersection / union;
        }
        
        function showResults(img, detections) {
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            const colors = ['#ED1C24', '#2b2b2b', '#f39c12', '#4CAF50', '#9b59b6'];
            detections.forEach((det) => {
                const color = colors[det.class % colors.length];
                ctx.strokeStyle = color;
                ctx.lineWidth = 4;
                ctx.strokeRect(det.x1, det.y1, det.x2 - det.x1, det.y2 - det.y1);
                ctx.fillStyle = color;
                const label = `${det.chineseName} ${(det.score * 100).toFixed(1)}%`;
                ctx.font = 'bold 20px Arial';
                const textWidth = ctx.measureText(label).width;
                ctx.fillRect(det.x1, det.y1 - 35, textWidth + 20, 35);
                ctx.fillStyle = 'white';
                ctx.fillText(label, det.x1 + 10, det.y1 - 10);
            });
            const resultHTML = detections.map(det => {
                const advice = expertAdvice[det.className] || { description: 'ç¼ºé™·æè¿°æš«ç„¡', causes: 'åŸå› åˆ†æä¸­',
                    solutions: ['è«‹è«®è©¢å°ˆæ¥­äººå“¡'], prevention: 'é é˜²æªæ–½å¾…è£œå……' };
                return `<div class="result-item"><div class="defect-header">
                    <div class="defect-name">${det.chineseName}</div>
                    <span class="badge">${(det.score * 100).toFixed(1)}%</span></div>
                    <div class="defect-info">
                        <div class="defect-section"><div class="defect-section-title">ğŸ” ç¼ºé™·æè¿°</div>${advice.description}</div>
                        <div class="defect-section"><div class="defect-section-title">âš ï¸ å¯èƒ½åŸå› </div>${advice.causes}</div>
                        <div class="defect-section"><div class="defect-section-title">âœ… ä¿®å¾©å»ºè­°</div>
                            ${advice.solutions.map((s, i) => `${i + 1}. ${s}`).join('<br>')}</div>
                        <div class="defect-section"><div class="defect-section-title">ğŸ›¡ï¸ é é˜²æªæ–½</div>${advice.prevention}</div>
                    </div></div>`;
            }).join('');
            const app = document.getElementById('app');
            app.innerHTML = `<div class="success">âœ… æª¢æ¸¬å®Œæˆï¼ç™¼ç¾ ${detections.length} å€‹ç¼ºé™·</div>
                <div class="card"><canvas id="resultCanvas" width="${canvas.width}" height="${canvas.height}"></canvas></div>
                ${detections.length > 0 ? `<div class="card"><div class="step-title">æª¢æ¸¬çµæœèˆ‡å°ˆå®¶å»ºè­°</div>${resultHTML}</div>` : 
                '<div class="card"><div class="success">âœ… æœªæª¢æ¸¬åˆ°ç¼ºé™·ï¼Œæ–½å·¥è³ªé‡è‰¯å¥½</div></div>'}
                <div class="card"><button class="btn" onclick="showImageUpload()">ğŸ“· æª¢æ¸¬æ–°ç…§ç‰‡</button>
                <button class="btn btn-black" onclick="showPhaseSelection()" style="margin-top: 10px;">ğŸ”„ é‡æ–°é¸æ“‡éšæ®µ</button></div>`;
            const displayCanvas = document.getElementById('resultCanvas');
            displayCanvas.getContext('2d').drawImage(canvas, 0, 0);
        }
        
        window.addEventListener('load', function() {
            console.log('ä¸Šå¥½ç‰Œæ™ºèƒ½æª¢æ¸¬ç³»çµ±å•Ÿå‹•...');
            tryLoadORT();
        });
    </script>
</body>
</html>
