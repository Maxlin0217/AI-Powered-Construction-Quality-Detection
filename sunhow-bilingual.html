<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ä¸Šå¥½ç‰Œç ‚æ¼¿ AI æ™ºèƒ½æ–½å·¥è³ªé‡æª¢æ¸¬ç³»çµ±">
    <meta name="theme-color" content="#ED1C24">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>ä¸Šå¥½ç‰Œæ–½å·¥æ™ºèƒ½æª¢æ¸¬</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", Arial, sans-serif;
        }
        
        body {
            background: #e8e8e8;
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
        }
        
        /* åŒ…è£è¢‹ä¸»å®¹å™¨ */
        .package-container {
            max-width: 500px;
            margin: 20px auto;
            background: white;
            position: relative;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.3),
                inset 0 0 0 1px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        /* åŒ…è£è¢‹é ‚éƒ¨å°å£ */
        .package-top {
            background: linear-gradient(to bottom, #f5f5f5 0%, white 100%);
            padding: 15px 20px 10px;
            position: relative;
            border-bottom: 2px solid #ddd;
        }
        
        .package-top::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: repeating-linear-gradient(
                90deg,
                #ddd 0px,
                #ddd 10px,
                transparent 10px,
                transparent 20px
            );
        }
        
        /* é ‚éƒ¨ç´…è‰²æ¨™èª - æ¯›ç­†æ›¸æ³•å­—é«” */
        .top-slogan {
            text-align: right;
            color: #ED1C24;
            font-size: 20px;
            font-weight: 900;
            letter-spacing: 5px;
            transform: rotate(-2deg);
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            font-family: "DFKai-SB", "æ¨™æ¥·é«”", "BiauKai", "Kaiti TC", "KaiTi", "æ¥·ä½“", cursive, serif;
        }
        
        /* å°èˆªæŒ‰éˆ• */
        .nav-overlay {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 999;
            display: flex;
            gap: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .nav-btn, .lang-btn {
            background: white;
            border: 2px solid #ED1C24;
            color: #ED1C24;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .nav-btn:hover, .lang-btn:hover {
            background: #ED1C24;
            color: white;
        }
        
        .lang-btn.active {
            background: #ED1C24;
            color: white;
        }
        
        /* Logoå€åŸŸ - ç™½è‰²èƒŒæ™¯ */
        .brand-section {
            background: white;
            padding: 40px 20px;
            position: relative;
            overflow: hidden;
        }
        
        .corner-logo {
            display: none;
        }
        
        /* ä¸­å¤®Logoæ¡† */
        .brand-box {
            background: white;
            margin: 0 auto;
            max-width: 320px;
            border-radius: 3px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .brand-chinese {
            font-size: 56px;
            font-weight: 900;
            color: white;
            letter-spacing: 8px;
            line-height: 1;
            margin: 0;
            padding: 35px 20px 20px;
            background: #ED1C24;
        }
        
        .brand-divider {
            width: 100%;
            height: 4px;
            background: #ED1C24;
            margin: 0;
        }
        
        .brand-english {
            font-size: 32px;
            font-weight: bold;
            color: #1a1a1a;
            letter-spacing: 10px;
            line-height: 1;
            margin: 0;
            padding: 20px 20px 30px;
            background: white;
        }
        
        /* å´é‚Šæ¢ç´‹ */
        .side-stripe-left,
        .side-stripe-right {
            position: absolute;
            top: 0;
            width: 25px;
            height: 100%;
            background: linear-gradient(to right, 
                rgba(0, 0, 0, 0.05) 0%,
                transparent 50%,
                rgba(0, 0, 0, 0.02) 100%
            );
        }
        
        .side-stripe-left {
            left: 0;
        }
        
        .side-stripe-right {
            right: 0;
            background: linear-gradient(to left, 
                rgba(0, 0, 0, 0.05) 0%,
                transparent 50%,
                rgba(0, 0, 0, 0.02) 100%
            );
        }
        
        /* é»‘è‰²ç”¢å“åç¨±å€ */
        .product-name-section {
            background: #2b2b2b;
            padding: 30px 20px;
            text-align: center;
            position: relative;
        }
        
        .product-main-title {
            font-size: 36px;
            font-weight: 900;
            color: white;
            letter-spacing: 12px;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .product-sub-title {
            font-size: 22px;
            font-weight: bold;
            color: white;
            letter-spacing: 6px;
            opacity: 0.95;
        }
        
        /* ç”¢å“è¦æ ¼å€ */
        .specs-section {
            background: white;
            padding: 30px 20px;
            border-top: 1px solid #ddd;
            text-align: center;
        }
        
        .specs-cert {
            font-size: 13px;
            color: #666;
            line-height: 2;
            margin-top: 5px;
        }
        
        /* ç”¢å“ç…§ç‰‡å±•ç¤º */
        .product-display {
            background: linear-gradient(135deg, #f9f9f9 0%, #e8e8e8 100%);
            padding: 40px 20px;
            text-align: center;
        }
        
        .product-image {
            max-width: 180px;
            height: auto;
            filter: drop-shadow(0 15px 35px rgba(0, 0, 0, 0.3));
            transition: transform 0.3s;
        }
        
        .product-image:hover {
            transform: scale(1.05) rotate(2deg);
        }
        
        /* å…§å®¹å€åŸŸ */
        .content-area {
            padding: 30px 20px;
            background: white;
        }
        
        .card {
            background: #fafafa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .card-highlight {
            border-color: #ED1C24;
            border-width: 3px;
            background: white;
        }
        
        .phase-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .phase-btn {
            background: white;
            border: 2px solid #ED1C24;
            padding: 18px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .phase-btn:hover {
            background: #fff5f5;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(237, 28, 36, 0.25);
        }
        
        .phase-btn.selected {
            background: #ED1C24;
            color: white;
            box-shadow: 0 6px 20px rgba(237, 28, 36, 0.4);
        }
        
        .phase-title {
            font-size: 17px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .phase-desc {
            font-size: 13px;
            line-height: 1.4;
            opacity: 0.85;
        }
        
        .phase-risks {
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            font-size: 12px;
        }
        
        .phase-btn.selected .phase-risks {
            border-top-color: rgba(255, 255, 255, 0.3);
        }
        
        .risk-tag {
            display: inline-block;
            background: #2b2b2b;
            color: white;
            padding: 3px 10px;
            border-radius: 3px;
            margin: 3px;
            font-size: 11px;
        }
        
        .phase-btn.selected .risk-tag {
            background: rgba(0, 0, 0, 0.3);
        }
        
        .btn {
            background: #ED1C24;
            color: white;
            border: none;
            padding: 18px 35px;
            border-radius: 5px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
            letter-spacing: 3px;
            text-transform: uppercase;
        }
        
        .btn:hover { 
            background: #c71820;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(237, 28, 36, 0.4);
        }
        
        .btn:disabled {
            background: #999;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .btn-black {
            background: #2b2b2b;
        }
        
        .btn-black:hover {
            background: #1a1a1a;
        }
        
        .btn-outline {
            background: white;
            color: #ED1C24;
            border: 3px solid #ED1C24;
        }
        
        .btn-outline:hover {
            background: #ED1C24;
            color: white;
        }
        
        .success {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 18px 25px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        
        .warning {
            background: linear-gradient(135deg, #FFC107, #ffb300);
            color: #333;
            padding: 18px 25px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        }
        
        .info {
            background: #f5f5f5;
            border-left: 5px solid #ED1C24;
            padding: 18px 25px;
            margin-top: 20px;
            font-size: 14px;
            line-height: 1.8;
        }
        
        .step-title {
            font-size: 26px;
            font-weight: 900;
            margin-bottom: 20px;
            color: #ED1C24;
            letter-spacing: 3px;
            border-left: 6px solid #ED1C24;
            padding-left: 18px;
        }
        
        img, canvas {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 3px solid #e0e0e0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .result-item {
            background: white;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 6px solid #ED1C24;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }
        
        .defect-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .defect-name {
            font-size: 24px;
            font-weight: 900;
            color: #ED1C24;
            letter-spacing: 2px;
        }
        
        .badge {
            background: #2b2b2b;
            color: white;
            padding: 8px 18px;
            border-radius: 5px;
            font-size: 15px;
            font-weight: bold;
        }
        
        .defect-info {
            background: #fafafa;
            padding: 25px;
            border-radius: 8px;
            margin-top: 15px;
            line-height: 1.9;
            border: 2px solid #f0f0f0;
        }
        
        .defect-section {
            margin-top: 18px;
        }
        
        .defect-section-title {
            color: #ED1C24;
            font-weight: 900;
            margin-bottom: 10px;
            font-size: 17px;
            letter-spacing: 1px;
        }
        
        input[type="file"] {
            display: none;
        }
        
        /* åº•éƒ¨åŒ…è£å°å£ */
        .package-bottom {
            background: linear-gradient(to top, #f5f5f5 0%, white 100%);
            padding: 20px;
            border-top: 2px solid #ddd;
            position: relative;
        }
        
        .package-bottom::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: repeating-linear-gradient(
                90deg,
                #ddd 0px,
                #ddd 10px,
                transparent 10px,
                transparent 20px
            );
        }
        
        /* Loading å‹•ç•« */
        .loading {
            text-align: center;
            padding: 50px 20px;
            color: #ED1C24;
            font-weight: bold;
            font-size: 18px;
        }
        
        .loading::after {
            content: "â³";
            font-size: 56px;
            display: block;
            margin-top: 20px;
            animation: spin 2s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .package-container {
                margin: 10px;
                border-radius: 5px;
            }
            
            .nav-overlay {
                top: 10px;
                flex-wrap: wrap;
                justify-content: center;
                padding: 8px;
                gap: 8px;
            }
            
            .nav-btn, .lang-btn {
                font-size: 12px;
                padding: 6px 15px;
            }
            
            .brand-chinese {
                font-size: 46px;
                letter-spacing: 6px;
            }
            
            .brand-english {
                font-size: 26px;
                letter-spacing: 8px;
            }
            
            .product-main-title {
                font-size: 28px;
                letter-spacing: 8px;
            }
            
            .product-sub-title {
                font-size: 18px;
            }
            
            .product-image {
                max-width: 150px;
            }
        }
    </style>
</head>
<body>
    <!-- å°èˆªåˆ— - æ•´åˆèªè¨€åˆ‡æ› -->
    <div class="nav-overlay">
        <button class="lang-btn active" onclick="switchLanguage('zh')" id="btn-zh">ğŸ‡¹ğŸ‡¼ ä¸­æ–‡</button>
        <button class="lang-btn" onclick="switchLanguage('vi')" id="btn-vi">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</button>
        <a href="https://www.mfgroup.com.tw/product.php?lang=tw&tb=3" class="nav-btn" target="_blank" data-zh="ğŸŒ å®˜ç¶²" data-vi="ğŸŒ Website">ğŸŒ å®˜ç¶²</a>
    </div>
    
    <!-- åŒ…è£è¢‹ä¸»å®¹å™¨ -->
    <div class="package-container">
        <!-- åŒ…è£è¢‹é ‚éƒ¨å°å£ -->
        <div class="package-top">
            <div class="top-slogan" data-zh="ä¸Šå¥½åç”¨ä¸Šå¥½æ–™" data-vi="NhÃ  tá»‘t dÃ¹ng váº­t liá»‡u tá»‘t">ä¸Šå¥½åç”¨ä¸Šå¥½æ–™</div>
        </div>
        
        <!-- Logoå€åŸŸ -->
        <div class="brand-section">
            <div class="corner-logo">ä¸Š</div>
            <div class="side-stripe-left"></div>
            <div class="side-stripe-right"></div>
            
            <div class="brand-box">
                <div class="brand-chinese">ä¸Šå¥½ç‰Œ</div>
                <div class="brand-divider"></div>
                <div class="brand-english">SUNHOW</div>
            </div>
        </div>
        
        <!-- é»‘è‰²ç”¢å“åç¨±å€ -->
        <div class="product-name-section">
            <div class="product-main-title" data-zh="æ–½å·¥æ™ºèƒ½æª¢æ¸¬" data-vi="Kiá»ƒm Tra ThÃ´ng Minh">æ–½å·¥æ™ºèƒ½æª¢æ¸¬</div>
            <div class="product-sub-title" data-zh="AI DETECTION" data-vi="PHÃT HIá»†N AI">AI DETECTION</div>
        </div>
        
        <!-- ç”¢å“è¦æ ¼å€ -->
        <div class="specs-section">
            <div class="specs-cert">
                <span data-zh="ISO 9001èªè­‰" data-vi="Chá»©ng nháº­n ISO 9001">ISO 9001èªè­‰</span><br>
                <span data-zh="CNSèªè­‰ç”¢å“" data-vi="Sáº£n pháº©m chá»©ng nháº­n CNS">CNSèªè­‰ç”¢å“</span><br>
                <span data-zh="ä¹¾æ‹Œç ‚æ¼¿å°ˆæ¥­è£½é€ " data-vi="ChuyÃªn sáº£n xuáº¥t vá»¯a khÃ´">ä¹¾æ‹Œç ‚æ¼¿å°ˆæ¥­è£½é€ </span>
            </div>
        </div>
        
        <!-- ç”¢å“å±•ç¤º -->
        <div class="product-display">
            <img src="product.jpg" alt="ä¸Šå¥½ç‰Œç ‚æ¼¿ Sunhow Mortar" class="product-image">
        </div>
        
        <!-- å…§å®¹å€åŸŸ -->
        <div class="content-area">
            <div id="app">
                <div class="card card-highlight">
                    <div class="loading" data-zh="ç³»çµ±å•Ÿå‹•ä¸­" data-vi="Há»‡ thá»‘ng Ä‘ang khá»Ÿi Ä‘á»™ng">ç³»çµ±å•Ÿå‹•ä¸­</div>
                </div>
            </div>
        </div>
        
        <!-- åº•éƒ¨å°å£ -->
        <div class="package-bottom">
            <div style="text-align: center; color: #666; font-size: 13px; line-height: 1.8;">
                <strong style="color: #ED1C24; font-size: 16px;">ä¸Šå¥½ç‰Œ SUNHOW</strong><br>
                <span data-zh="å“è³ªä¿è­‰ Â· å€¼å¾—ä¿¡è³´" data-vi="Äáº£m báº£o cháº¥t lÆ°á»£ng Â· ÄÃ¡ng tin cáº­y">å“è³ªä¿è­‰ Â· å€¼å¾—ä¿¡è³´</span><br>
                <span data-zh="æ–½å·¥æ™ºèƒ½æª¢æ¸¬ç³»çµ±" data-vi="Há»‡ thá»‘ng kiá»ƒm tra thÃ´ng minh">æ–½å·¥æ™ºèƒ½æª¢æ¸¬ç³»çµ±</span>
            </div>
        </div>
    </div>

    <script>
        // ========== èªè¨€ç³»çµ± ==========
        let currentLang = localStorage.getItem('language') || 'zh';
        
        const translations = {
            zh: {
                systemStarting: 'ç³»çµ±å•Ÿå‹•ä¸­',
                systemReady: 'ç³»çµ±å·²å°±ç·’',
                loadingModel: 'æ­£åœ¨è¼‰å…¥ AI æ¨¡å‹',
                modelLoaded: 'æ¨¡å‹è¼‰å…¥æˆåŠŸ',
                cannotAutoLoad: 'ç„¡æ³•è‡ªå‹•è¼‰å…¥æ¨¡å‹',
                manualUpload: 'æ‰‹å‹•ä¸Šå‚³æ¨¡å‹',
                selectModel: 'é¸æ“‡ best.onnx',
                step1: 'æ­¥é©Ÿ 1ï¼šé¸æ“‡æ–½å·¥éšæ®µ',
                step2: 'æ­¥é©Ÿ 2ï¼šä¸Šå‚³ç…§ç‰‡',
                selectPhoto: 'é¸æ“‡ç…§ç‰‡',
                photoLoaded: 'ç…§ç‰‡å·²è¼‰å…¥',
                startDetection: 'é–‹å§‹æª¢æ¸¬',
                detecting: 'æª¢æ¸¬ä¸­...',
                selectNewPhoto: 'é‡é¸ç…§ç‰‡',
                reselectStage: 'é‡æ–°é¸æ“‡éšæ®µ',
                skip: 'è·³éï¼ˆé€šç”¨æª¢æ¸¬ï¼‰',
                stageWarning: 'æœ¬éšæ®µé‡é»æª¢æ¸¬ï¼š',
                detectionComplete: 'æª¢æ¸¬å®Œæˆï¼ç™¼ç¾',
                defects: 'å€‹ç¼ºé™·',
                noDefects: 'æœªæª¢æ¸¬åˆ°ç¼ºé™·ï¼Œæ–½å·¥è³ªé‡è‰¯å¥½',
                resultAndAdvice: 'æª¢æ¸¬çµæœèˆ‡å°ˆå®¶å»ºè­°',
                defectDescription: 'ç¼ºé™·æè¿°',
                possibleCauses: 'å¯èƒ½åŸå› ',
                repairSuggestions: 'ä¿®å¾©å»ºè­°',
                preventiveMeasures: 'é é˜²æªæ–½',
                confidence: 'ä¿¡å¿ƒåº¦',
                newDetection: 'æª¢æ¸¬æ–°ç…§ç‰‡',
                commonRisks: 'å¸¸è¦‹é¢¨éšªï¼š',
                tip: 'å»ºè­°ï¼šä½¿ç”¨æ¸…æ™°ç…§ç‰‡ï¼Œç¢ºä¿ç¼ºé™·éƒ¨ä½æ¸…æ¥šå¯è¦‹'
            },
            vi: {
                systemStarting: 'Há»‡ thá»‘ng Ä‘ang khá»Ÿi Ä‘á»™ng',
                systemReady: 'Há»‡ thá»‘ng Ä‘Ã£ sáºµn sÃ ng',
                loadingModel: 'Äang táº£i mÃ´ hÃ¬nh AI',
                modelLoaded: 'Táº£i mÃ´ hÃ¬nh thÃ nh cÃ´ng',
                cannotAutoLoad: 'KhÃ´ng thá»ƒ tá»± Ä‘á»™ng táº£i mÃ´ hÃ¬nh',
                manualUpload: 'Táº£i lÃªn thá»§ cÃ´ng',
                selectModel: 'Chá»n best.onnx',
                step1: 'BÆ°á»›c 1: Chá»n giai Ä‘oáº¡n thi cÃ´ng',
                step2: 'BÆ°á»›c 2: Táº£i áº£nh lÃªn',
                selectPhoto: 'Chá»n áº£nh',
                photoLoaded: 'áº¢nh Ä‘Ã£ Ä‘Æ°á»£c táº£i',
                startDetection: 'Báº¯t Ä‘áº§u kiá»ƒm tra',
                detecting: 'Äang kiá»ƒm tra...',
                selectNewPhoto: 'Chá»n áº£nh khÃ¡c',
                reselectStage: 'Chá»n láº¡i giai Ä‘oáº¡n',
                skip: 'Bá» qua (Kiá»ƒm tra chung)',
                stageWarning: 'Trá»ng tÃ¢m kiá»ƒm tra giai Ä‘oáº¡n nÃ y:',
                detectionComplete: 'HoÃ n táº¥t! PhÃ¡t hiá»‡n',
                defects: 'khuyáº¿t Ä‘iá»ƒm',
                noDefects: 'KhÃ´ng phÃ¡t hiá»‡n khuyáº¿t Ä‘iá»ƒm, cháº¥t lÆ°á»£ng thi cÃ´ng tá»‘t',
                resultAndAdvice: 'Káº¿t quáº£ kiá»ƒm tra & TÆ° váº¥n chuyÃªn gia',
                defectDescription: 'MÃ´ táº£ khuyáº¿t Ä‘iá»ƒm',
                possibleCauses: 'NguyÃªn nhÃ¢n cÃ³ thá»ƒ',
                repairSuggestions: 'Äá» xuáº¥t sá»­a chá»¯a',
                preventiveMeasures: 'Biá»‡n phÃ¡p phÃ²ng ngá»«a',
                confidence: 'Äá»™ tin cáº­y',
                newDetection: 'Kiá»ƒm tra áº£nh má»›i',
                commonRisks: 'Rá»§i ro thÆ°á»ng gáº·p:',
                tip: 'Gá»£i Ã½: Sá»­ dá»¥ng áº£nh rÃµ nÃ©t, Ä‘áº£m báº£o vá»‹ trÃ­ khuyáº¿t Ä‘iá»ƒm rÃµ rÃ ng'
            }
        };
        
        function switchLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('language', lang);
            
            // æ›´æ–°èªè¨€æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('btn-' + lang).classList.add('active');
            
            // æ›´æ–°æ‰€æœ‰å¸¶æœ‰ data-zh å’Œ data-vi çš„å…ƒç´ 
            document.querySelectorAll('[data-zh]').forEach(el => {
                if (lang === 'zh') {
                    el.textContent = el.getAttribute('data-zh');
                } else {
                    el.textContent = el.getAttribute('data-vi');
                }
            });
            
            // æ›´æ–°é é¢æ¨™é¡Œ
            document.documentElement.lang = lang === 'zh' ? 'zh-TW' : 'vi';
            
            // é‡æ–°è¼‰å…¥ç•¶å‰è¦–åœ–
            if (session) {
                if (currentImage) {
                    showImagePreview();
                } else {
                    showPhaseSelection();
                }
            }
        }
        
        function t(key) {
            return translations[currentLang][key] || key;
        }
        
        // é é¢è¼‰å…¥æ™‚æ‡‰ç”¨å„²å­˜çš„èªè¨€
        window.addEventListener('DOMContentLoaded', () => {
            switchLanguage(currentLang);
        });
        
        // ========== YOLO æª¢æ¸¬ç³»çµ± ==========
        let session = null;
        let currentImage = null;
        let selectedPhase = null;
        
        const INPUT_SIZE = 640;
        const CONFIDENCE_THRESHOLD = 0.25;
        const IOU_THRESHOLD = 0.45;
        
        const classNames = [
            'Crack', 'Efflorescence', 'Rebar', 'Rust', 'Scaling', 'Spall', 'Spallingw',
            'Hollowing', 'Bad_corner', 'Sandy_surface', 'Honeycomb'
        ];
        
        const classNamesChinese = {
            'Crack': 'è£‚ç¸«',
            'Efflorescence': 'ç™½è¯',
            'Rebar': 'é‹¼ç­‹å¤–éœ²',
            'Rust': 'é½è•',
            'Scaling': 'å‰è½',
            'Spall': 'å‰é›¢',
            'Spallingw': 'å‰é›¢Wå‹',
            'Hollowing': 'ç©ºé¼“',
            'Bad_corner': 'é™°é™½è§’ä¸é †ç›´',
            'Sandy_surface': 'è¡¨é¢ç²—ç³™/èµ·ç ‚',
            'Honeycomb': 'èœ‚çª©'
        };
        
        const classNamesVietnamese = {
            'Crack': 'Váº¿t ná»©t',
            'Efflorescence': 'Phong hÃ³a tráº¯ng',
            'Rebar': 'ThÃ©p lá»™ ra',
            'Rust': 'Gá»‰ sÃ©t',
            'Scaling': 'Bong trÃ³c',
            'Spall': 'Bong váº£y',
            'Spallingw': 'Bong váº£y W',
            'Hollowing': 'Rá»—ng bÃªn trong',
            'Bad_corner': 'GÃ³c khÃ´ng tháº³ng',
            'Sandy_surface': 'Bá» máº·t thÃ´/cÃ¡t',
            'Honeycomb': 'Tá»• ong'
        };
        
        const constructionPhases = {
            'base': {
                name: { zh: 'åŸºå±¤è™•ç†', vi: 'Xá»­ lÃ½ ná»n' },
                description: { zh: 'æ¸…ç†åŸºå±¤ã€æ¾†æ°´æ¿•æ½¤ã€å¡—åˆ·ç•Œé¢åŠ‘', vi: 'LÃ m sáº¡ch, lÃ m áº©m, sÆ¡n lá»›p lÃ³t' },
                risks: { zh: ['ç©ºé¼“', 'å‰é›¢'], vi: ['Rá»—ng', 'Bong trÃ³c'] }
            },
            'datum': {
                name: { zh: 'åŠå‚ç·šã€åšç°é¤…', vi: 'ÄÃ¡nh dáº¥u & chuáº©n bá»‹' },
                description: { zh: 'å½ˆç·šå®šä½ã€è¨­ç½®ç°é¤…ã€è¨­ç½®æ²–ç­‹', vi: 'ÄÃ¡nh dáº¥u vá»‹ trÃ­, Ä‘áº·t má»‘c' },
                risks: { zh: ['é™°é™½è§’ä¸é †ç›´'], vi: ['GÃ³c khÃ´ng tháº³ng'] }
            },
            'corner': {
                name: { zh: 'è­·è§’æ–½å·¥', vi: 'Thi cÃ´ng gÃ³c' },
                description: { zh: 'å®‰è£è­·è§’æ¢ã€åŠ è¨­åŠ å¼·ç¶²', vi: 'Láº¯p thanh gÃ³c, lÆ°á»›i tÄƒng cÆ°á»ng' },
                risks: { zh: ['è£‚ç¸«', 'é™°é™½è§’ä¸é †ç›´'], vi: ['Váº¿t ná»©t', 'GÃ³c khÃ´ng tháº³ng'] }
            },
            'base_plaster': {
                name: { zh: 'åº•å±¤æŠ¹ç°', vi: 'TrÃ¡t lá»›p ná»n' },
                description: { zh: 'ç”©æ¼¿ã€æŠ¹åº•ç°ï¼ˆ5-7mmï¼‰', vi: 'Phun vá»¯a, trÃ¡t ná»n (5-7mm)' },
                risks: { zh: ['ç©ºé¼“', 'è£‚ç¸«'], vi: ['Rá»—ng', 'Váº¿t ná»©t'] }
            },
            'middle_plaster': {
                name: { zh: 'ä¸­å±¤æŠ¹ç°', vi: 'TrÃ¡t lá»›p giá»¯a' },
                description: { zh: 'æŠ¹ä¸­å±¤ï¼ˆ8-10mmï¼‰ã€æ“å¹³', vi: 'TrÃ¡t lá»›p giá»¯a (8-10mm), lÃ m pháº³ng' },
                risks: { zh: ['è£‚ç¸«', 'è¡¨é¢ç²—ç³™'], vi: ['Váº¿t ná»©t', 'Bá» máº·t thÃ´'] }
            },
            'finish_plaster': {
                name: { zh: 'é¢å±¤æŠ¹ç°', vi: 'TrÃ¡t lá»›p hoÃ n thiá»‡n' },
                description: { zh: 'æŠ¹é¢å±¤ï¼ˆ2-3mmï¼‰ã€å£“å…‰', vi: 'TrÃ¡t lá»›p hoÃ n thiá»‡n (2-3mm), lÃ m nháºµn' },
                risks: { zh: ['è¡¨é¢ç²—ç³™/èµ·ç ‚', 'ç™½è¯'], vi: ['Bá» máº·t thÃ´/cÃ¡t', 'Phong hÃ³a'] }
            },
            'curing': {
                name: { zh: 'é¤Šè­·éšæ®µ', vi: 'Giai Ä‘oáº¡n báº£o dÆ°á»¡ng' },
                description: { zh: 'å™´æ°´é¤Šè­·ï¼ŒæŒçºŒ â‰¥ 7 å¤©', vi: 'Phun nÆ°á»›c báº£o dÆ°á»¡ng â‰¥ 7 ngÃ y' },
                risks: { zh: ['è£‚ç¸«', 'èµ·ç ‚'], vi: ['Váº¿t ná»©t', 'CÃ¡t'] }
            },
            'final': {
                name: { zh: 'æˆå“é©—æ”¶', vi: 'Nghiá»‡m thu' },
                description: { zh: 'å…¨é¢æª¢æŸ¥è³ªé‡', vi: 'Kiá»ƒm tra toÃ n diá»‡n cháº¥t lÆ°á»£ng' },
                risks: { zh: ['æ‰€æœ‰ç¼ºé™·é¡å‹'], vi: ['Táº¥t cáº£ cÃ¡c loáº¡i'] }
            }
        };
        
        const expertAdvice = {
            'Crack': {
                description: { 
                    zh: 'è¡¨é¢ç´°å°æˆ–æ˜é¡¯çš„è£‚ç¸«ï¼Œå¯èƒ½ç‚ºä¹¾ç¸®è£‚ç¸«æˆ–çµæ§‹è£‚ç¸«',
                    vi: 'Váº¿t ná»©t nhá» hoáº·c rÃµ rÃ ng trÃªn bá» máº·t, cÃ³ thá»ƒ lÃ  váº¿t ná»©t co ngÃ³t hoáº·c káº¿t cáº¥u'
                },
                causes: {
                    zh: 'ç ‚æ¼¿é…æ¯”æ°´æ³¥éå¤šã€æŠ¹ç°å¤ªåšæœªåˆ†å±¤ã€ç•°è³ªææ–™äº¤æ¥è™•æœªåŠ å¼·',
                    vi: 'Xi mÄƒng quÃ¡ nhiá»u, trÃ¡t quÃ¡ dÃ y, khÃ´ng gia cá»‘ nÆ¡i tiáº¿p giÃ¡p váº­t liá»‡u khÃ¡c'
                },
                solutions: {
                    zh: ['ç‰†æ ¹ã€äº¤æ¥è™•åŠ è¨­ 300mm å¯¬åŠ å¼·ç¶²', 'åš´æ ¼åŸ·è¡Œåˆ†å±¤æŠ¹ç°ï¼Œå–®å±¤åšåº¦ < 9mm', 'ä½¿ç”¨ä¸Šå¥½ç‰Œå°ˆæ¥­ç ‚æ¼¿'],
                    vi: ['ThÃªm lÆ°á»›i tÄƒng cÆ°á»ng 300mm táº¡i chÃ¢n tÆ°á»ng', 'TrÃ¡t tá»«ng lá»›p, má»—i lá»›p < 9mm', 'Sá»­ dá»¥ng vá»¯a Sunhow chuyÃªn nghiá»‡p']
                },
                prevention: {
                    zh: 'äº¤æ¥è™•æ›ç¶²ã€åš´æ ¼æ§åˆ¶åšåº¦ã€å……åˆ†é¤Šè­·',
                    vi: 'Treo lÆ°á»›i nÆ¡i tiáº¿p giÃ¡p, kiá»ƒm soÃ¡t Ä‘á»™ dÃ y, báº£o dÆ°á»¡ng Ä‘áº§y Ä‘á»§'
                }
            },
            'Hollowing': {
                description: {
                    zh: 'ç‰†é¢å±€éƒ¨é¼“èµ·ã€é¾œè£‚ï¼Œåš´é‡æ™‚å‡ºç¾å¡Šç‹€è„«è½',
                    vi: 'TÆ°á»ng phá»“ng lÃªn cá»¥c bá»™, ná»©t ráº¡n, nghiÃªm trá»ng cÃ³ thá»ƒ bong ra tá»«ng máº£ng'
                },
                causes: {
                    zh: 'åŸºå±¤æ¸…ç†ä¸æ·¨ã€æœªæå‰æ¾†æ°´æ¿•æ½¤ã€ç”©æ¼¿å¼·åº¦ä¸è¶³',
                    vi: 'Ná»n khÃ´ng sáº¡ch, khÃ´ng tÆ°á»›i áº©m trÆ°á»›c, phun vá»¯a khÃ´ng Ä‘á»§ máº¡nh'
                },
                solutions: {
                    zh: ['æ•²é™¤ç©ºé¼“å€åŸŸï¼Œå¾¹åº•æ¸…ç†åŸºå±¤', 'åˆ·ä¸€é“å«å»ºç¯‰è† çš„ç´ æ°´æ³¥æ¼¿', 'ä½¿ç”¨ä¸Šå¥½ç‰Œç ‚æ¼¿é‡æ–°åˆ†å±¤æŠ¹ç°'],
                    vi: ['GÃµ bá» vÃ¹ng rá»—ng, lÃ m sáº¡ch ná»n', 'QuÃ©t má»™t lá»›p xi mÄƒng cÃ³ keo', 'DÃ¹ng vá»¯a Sunhow trÃ¡t láº¡i tá»«ng lá»›p']
                },
                prevention: {
                    zh: 'åŸºå±¤æ¸…ç†å¾¹åº•ã€æ¾†æ°´å……åˆ†ã€ç”©æ¼¿åˆ°ä½',
                    vi: 'LÃ m sáº¡ch ná»n ká»¹, tÆ°á»›i nÆ°á»›c Ä‘á»§, phun vá»¯a Ä‘Ãºng cÃ¡ch'
                }
            },
            'Bad_corner': {
                description: {
                    zh: 'ç‰†è§’é‚Šç·šä¸ç›´ã€æ­ªæ–œï¼Œç”¨æ–¹å°ºæª¢æŸ¥ä¸æ–¹æ­£',
                    vi: 'GÃ³c tÆ°á»ng khÃ´ng tháº³ng, lá»‡ch, kiá»ƒm tra báº±ng thÆ°á»›c vuÃ´ng khÃ´ng vuÃ´ng gÃ³c'
                },
                causes: {
                    zh: 'æœªåšç°é¤…ã€æ²–ç­‹æ‰¾è¦çŸ©ã€æœªä½¿ç”¨å°ˆç”¨é™°é™½è§’æŠ¹å­',
                    vi: 'KhÃ´ng Ä‘Ã¡nh má»‘c chuáº©n, khÃ´ng dÃ¹ng dá»¥ng cá»¥ chuyÃªn dá»¥ng cho gÃ³c'
                },
                solutions: {
                    zh: ['æŠ¹ç°å‰å¿…é ˆå½ˆåå­—ç·šã€åšç°é¤…', 'ä½¿ç”¨é•·é å°ºèˆ‡å°ˆç”¨æŠ¹å­ä¸Šä¸‹æŠ½å¹³', 'åš´é‡è®Šå½¢éœ€é‡æ–°æ–½ä½œ'],
                    vi: ['Pháº£i Ä‘Ã¡nh dáº¥u chá»¯ tháº­p, Ä‘áº·t má»‘c trÆ°á»›c khi trÃ¡t', 'DÃ¹ng thÆ°á»›c dÃ i vÃ  dá»¥ng cá»¥ chuyÃªn dá»¥ng', 'Biáº¿n dáº¡ng nghiÃªm trá»ng cáº§n lÃ m láº¡i']
                },
                prevention: {
                    zh: 'ç²¾ç¢ºæ”¾ç·šã€ç°é¤…æ²–ç­‹åˆ°ä½ã€ä½¿ç”¨å°ˆç”¨å·¥å…·',
                    vi: 'ÄÃ¡nh dáº¥u chÃ­nh xÃ¡c, Ä‘áº·t má»‘c Ä‘Ãºng, dÃ¹ng dá»¥ng cá»¥ chuyÃªn dá»¥ng'
                }
            },
            'Sandy_surface': {
                description: {
                    zh: 'ç‰†é¢è‰²æ¾¤ä¸å‡ã€æ¥æ§æ˜é¡¯ï¼Œè¡¨é¢é¬†æ•£æ˜“æ‰ç ‚',
                    vi: 'MÃ u tÆ°á»ng khÃ´ng Ä‘á»u, ná»‘i rÃµ, bá» máº·t rá»i dá»… rÆ¡i cÃ¡t'
                },
                causes: {
                    zh: 'é¤Šè­·ä¸è¶³å¤±æ°´éå¿«ã€ä½¿ç”¨éæ™‚ç°ã€å£“å…‰æ™‚é–“ä¸ç•¶',
                    vi: 'Báº£o dÆ°á»¡ng khÃ´ng Ä‘á»§ máº¥t nÆ°á»›c nhanh, dÃ¹ng vá»¯a cÅ©, Ä‘Ã¡nh bÃ³ng khÃ´ng Ä‘Ãºng lÃºc'
                },
                solutions: {
                    zh: ['æŠ¹ç°å¾Œ 12 å°æ™‚å…§é–‹å§‹å™´æ°´é¤Šè­·', 'åš´ç¦ä½¿ç”¨è¶…é 3 å°æ™‚çš„ã€Œéæ™‚ç°ã€', 'é¸ç”¨ä¸Šå¥½ç‰Œé«˜å“è³ªç ‚æ¼¿'],
                    vi: ['Báº¯t Ä‘áº§u phun nÆ°á»›c trong 12 giá» sau trÃ¡t', 'Cáº¥m dÃ¹ng vá»¯a quÃ¡ 3 giá»', 'Chá»n vá»¯a Sunhow cháº¥t lÆ°á»£ng cao']
                },
                prevention: {
                    zh: 'å£“å…‰æ™‚æ©Ÿæ­£ç¢ºã€å……åˆ†é¤Šè­·ã€ä½¿ç”¨æ–°é®®ç ‚æ¼¿',
                    vi: 'ÄÃ¡nh bÃ³ng Ä‘Ãºng lÃºc, báº£o dÆ°á»¡ng Ä‘á»§, dÃ¹ng vá»¯a tÆ°Æ¡i'
                }
            }
        };
        
        function tryLoadORT() {
            const localScript = document.createElement('script');
            localScript.src = './ort.min.js';
            localScript.onload = () => { console.log('âœ… æœ¬åœ°è¼‰å…¥'); checkORT(); };
            localScript.onerror = () => { console.log('å˜—è©¦ CDN'); tryLoadFromCDN(); };
            document.head.appendChild(localScript);
        }
        
        function tryLoadFromCDN() {
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/onnxruntime-web@1.19.2/dist/ort.min.js';
            script.onload = () => { console.log('âœ… CDN è¼‰å…¥'); checkORT(); };
            script.onerror = () => { console.error('âŒ è¼‰å…¥å¤±æ•—'); showOfflineInstructions(); };
            document.head.appendChild(script);
        }
        
        function checkORT() {
            if (typeof ort !== 'undefined') { console.log('âœ… æº–å‚™å°±ç·’'); autoLoadModel(); }
            else { setTimeout(checkORT, 100); }
        }
        
        function showOfflineInstructions() {
            document.getElementById('app').innerHTML = `
                <div class="card"><div class="warning">âš ï¸ ${t('cannotAutoLoad')}<br><small>è«‹ç¢ºä¿é€šéä¼ºæœå™¨è¨ªå•</small></div>
                <button class="btn" onclick="location.reload()">ğŸ”„ ${currentLang === 'zh' ? 'é‡æ–°è¼‰å…¥' : 'Táº£i láº¡i'}</button></div>`;
        }
        
        async function autoLoadModel() {
            const app = document.getElementById('app');
            app.innerHTML = `<div class="card card-highlight"><div class="loading">${t('loadingModel')}</div></div>`;
            try {
                const response = await fetch('best.onnx');
                if (!response.ok) throw new Error('æ¨¡å‹æª”æ¡ˆä¸å­˜åœ¨');
                const arrayBuffer = await response.arrayBuffer();
                session = await ort.InferenceSession.create(arrayBuffer);
                console.log('âœ… æ¨¡å‹è¼‰å…¥æˆåŠŸ');
                showPhaseSelection();
            } catch (err) {
                console.error('è¼‰å…¥å¤±æ•—:', err);
                showManualUpload();
            }
        }
        
        function showManualUpload() {
            const app = document.getElementById('app');
            app.innerHTML = `<div class="card"><div class="warning">âš ï¸ ${t('cannotAutoLoad')}</div>
                <div class="step-title">${t('manualUpload')}</div>
                <button class="btn" onclick="selectModel()">ğŸ“¤ ${t('selectModel')}</button>
                <input type="file" id="modelInput" accept=".onnx" onchange="loadModel(this)"></div>`;
        }
        
        function selectModel() { document.getElementById('modelInput').click(); }
        
        async function loadModel(input) {
            const file = input.files[0];
            if (!file) return;
            const app = document.getElementById('app');
            app.innerHTML = `<div class="card card-highlight"><div class="loading">${t('loadingModel')}</div></div>`;
            try {
                const arrayBuffer = await file.arrayBuffer();
                session = await ort.InferenceSession.create(arrayBuffer);
                showPhaseSelection();
            } catch (err) {
                app.innerHTML = `<div class="card"><div class="warning">âŒ ${currentLang === 'zh' ? 'è¼‰å…¥å¤±æ•—' : 'Táº£i tháº¥t báº¡i'}: ${err.message}</div>
                    <button class="btn" onclick="showManualUpload()">ğŸ”„ ${currentLang === 'zh' ? 'é‡è©¦' : 'Thá»­ láº¡i'}</button></div>`;
            }
        }
        
        function showPhaseSelection() {
            const app = document.getElementById('app');
            let phasesHTML = '';
            for (const [key, phase] of Object.entries(constructionPhases)) {
                const risksHTML = phase.risks[currentLang].map(risk => 
                    `<span class="risk-tag">${risk}</span>`
                ).join('');
                
                phasesHTML += `<div class="phase-btn" onclick="selectPhase('${key}')">
                    <div class="phase-title">${phase.name[currentLang]}</div>
                    <div class="phase-desc">${phase.description[currentLang]}</div>
                    <div class="phase-risks"><strong>${t('commonRisks')}</strong><br>${risksHTML}</div></div>`;
            }
            app.innerHTML = `<div class="success">âœ… ${t('systemReady')}</div>
                <div class="card card-highlight"><div class="step-title">${t('step1')}</div>
                <div class="phase-selector">${phasesHTML}</div>
                <button class="btn btn-outline" onclick="skipPhaseSelection()">â­ï¸ ${t('skip')}</button></div>`;
        }
        
        function selectPhase(phaseKey) {
            selectedPhase = phaseKey;
            document.querySelectorAll('.phase-btn').forEach(btn => btn.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            setTimeout(() => showImageUpload(), 500);
        }
        
        function skipPhaseSelection() { selectedPhase = null; showImageUpload(); }
        
        function showImageUpload() {
            const app = document.getElementById('app');
            let phaseWarning = '';
            if (selectedPhase) {
                const phase = constructionPhases[selectedPhase];
                phaseWarning = `<div class="warning"><strong>âš ï¸ ${t('stageWarning')}</strong>${phase.risks[currentLang].join('ã€')}</div>`;
            }
            app.innerHTML = `<div class="success">âœ… ${t('systemReady')}</div>${phaseWarning}
                <div class="card card-highlight"><div class="step-title">${t('step2')}</div>
                <button class="btn" onclick="selectImage()">ğŸ“· ${t('selectPhoto')}</button>
                <input type="file" id="imageInput" accept="image/*" onchange="loadImage(this)">
                <div class="info">ğŸ’¡ ${t('tip')}</div></div>`;
        }
        
        function selectImage() { document.getElementById('imageInput').click(); }
        
        function loadImage(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) { currentImage = e.target.result; showImagePreview(); };
            reader.readAsDataURL(file);
        }
        
        function showImagePreview() {
            const app = document.getElementById('app');
            app.innerHTML = `<div class="success">âœ… ${t('photoLoaded')}</div><div class="card"><img src="${currentImage}">
                <button class="btn" onclick="runDetection()">ğŸ¯ ${t('startDetection')}</button>
                <button class="btn btn-outline" onclick="showImageUpload()" style="margin-top: 10px;">ğŸ“· ${t('selectNewPhoto')}</button></div>`;
        }
        
        async function runDetection() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'â³ ' + t('detecting');
            try {
                const img = new Image();
                img.src = currentImage;
                await new Promise(resolve => img.onload = resolve);
                const input = await preprocessImage(img);
                const feeds = {};
                feeds[session.inputNames[0]] = input;
                const results = await session.run(feeds);
                const detections = postprocess(results[session.outputNames[0]], img.width, img.height);
                showResults(img, detections);
            } catch (err) {
                console.error('æª¢æ¸¬éŒ¯èª¤:', err);
                document.getElementById('app').innerHTML = `<div class="card"><div class="warning">âŒ ${currentLang === 'zh' ? 'æª¢æ¸¬å¤±æ•—' : 'Kiá»ƒm tra tháº¥t báº¡i'}: ${err.message}</div>
                    <button class="btn" onclick="showImagePreview()">ğŸ”„ ${currentLang === 'zh' ? 'é‡è©¦' : 'Thá»­ láº¡i'}</button></div>`;
            }
        }
        
        async function preprocessImage(img) {
            const canvas = document.createElement('canvas');
            canvas.width = INPUT_SIZE;
            canvas.height = INPUT_SIZE;
            const ctx = canvas.getContext('2d');
            const scale = Math.min(INPUT_SIZE / img.width, INPUT_SIZE / img.height);
            const scaledWidth = img.width * scale;
            const scaledHeight = img.height * scale;
            const x = (INPUT_SIZE - scaledWidth) / 2;
            const y = (INPUT_SIZE - scaledHeight) / 2;
            ctx.fillStyle = '#114';
            ctx.fillRect(0, 0, INPUT_SIZE, INPUT_SIZE);
            ctx.drawImage(img, x, y, scaledWidth, scaledHeight);
            const imageData = ctx.getImageData(0, 0, INPUT_SIZE, INPUT_SIZE);
            const pixels = imageData.data;
            const red = [], green = [], blue = [];
            for (let i = 0; i < pixels.length; i += 4) {
                red.push(pixels[i] / 255);
                green.push(pixels[i + 1] / 255);
                blue.push(pixels[i + 2] / 255);
            }
            const input = Float32Array.from([...red, ...green, ...blue]);
            return new ort.Tensor('float32', input, [1, 3, INPUT_SIZE, INPUT_SIZE]);
        }
        
        function postprocess(output, imgWidth, imgHeight) {
            const data = output.data;
            const dims = output.dims;
            const numClasses = classNames.length;
            const numBoxes = dims[2] || dims[1];
            const boxes = [];
            const scale = Math.min(INPUT_SIZE / imgWidth, INPUT_SIZE / imgHeight);
            for (let i = 0; i < numBoxes; i++) {
                let maxScore = 0;
                let maxClass = 0;
                for (let c = 0; c < numClasses; c++) {
                    const score = data[i + (4 + c) * numBoxes];
                    if (score > maxScore) { maxScore = score; maxClass = c; }
                }
                if (maxScore < CONFIDENCE_THRESHOLD) continue;
                const x = data[i];
                const y = data[i + numBoxes];
                const w = data[i + 2 * numBoxes];
                const h = data[i + 3 * numBoxes];
                const x1 = ((x - w / 2) - (INPUT_SIZE - imgWidth * scale) / 2) / scale;
                const y1 = ((y - h / 2) - (INPUT_SIZE - imgHeight * scale) / 2) / scale;
                const x2 = ((x + w / 2) - (INPUT_SIZE - imgWidth * scale) / 2) / scale;
                const y2 = ((y + h / 2) - (INPUT_SIZE - imgHeight * scale) / 2) / scale;
                boxes.push({
                    x1, y1, x2, y2, score: maxScore, class: maxClass,
                    className: classNames[maxClass], 
                    chineseName: classNamesChinese[classNames[maxClass]],
                    vietnameseName: classNamesVietnamese[classNames[maxClass]]
                });
            }
            return nms(boxes, IOU_THRESHOLD);
        }
        
        function nms(boxes, iouThreshold) {
            boxes.sort((a, b) => b.score - a.score);
            const keep = [];
            while (boxes.length > 0) {
                keep.push(boxes[0]);
                boxes = boxes.slice(1).filter(box => {
                    const iou = calculateIOU(keep[keep.length - 1], box);
                    return iou < iouThreshold;
                });
            }
            return keep;
        }
        
        function calculateIOU(box1, box2) {
            const x1 = Math.max(box1.x1, box2.x1);
            const y1 = Math.max(box1.y1, box2.y1);
            const x2 = Math.min(box1.x2, box2.x2);
            const y2 = Math.min(box1.y2, box2.y2);
            const intersection = Math.max(0, x2 - x1) * Math.max(0, y2 - y1);
            const area1 = (box1.x2 - box1.x1) * (box1.y2 - box1.y1);
            const area2 = (box2.x2 - box2.x1) * (box2.y2 - box2.y1);
            const union = area1 + area2 - intersection;
            return intersection / union;
        }
        
        function showResults(img, detections) {
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            const colors = ['#ED1C24', '#2b2b2b', '#f39c12', '#4CAF50', '#9b59b6'];
            detections.forEach((det) => {
                const color = colors[det.class % colors.length];
                ctx.strokeStyle = color;
                ctx.lineWidth = 4;
                ctx.strokeRect(det.x1, det.y1, det.x2 - det.x1, det.y2 - det.y1);
                ctx.fillStyle = color;
                const defectName = currentLang === 'zh' ? det.chineseName : det.vietnameseName;
                const label = `${defectName} ${(det.score * 100).toFixed(1)}%`;
                ctx.font = 'bold 20px Arial';
                const textWidth = ctx.measureText(label).width;
                ctx.fillRect(det.x1, det.y1 - 35, textWidth + 20, 35);
                ctx.fillStyle = 'white';
                ctx.fillText(label, det.x1 + 10, det.y1 - 10);
            });
            const resultHTML = detections.map(det => {
                const advice = expertAdvice[det.className] || { 
                    description: { zh: 'ç¼ºé™·æè¿°æš«ç„¡', vi: 'ChÆ°a cÃ³ mÃ´ táº£' },
                    causes: { zh: 'åŸå› åˆ†æä¸­', vi: 'Äang phÃ¢n tÃ­ch' },
                    solutions: { zh: ['è«‹è«®è©¢å°ˆæ¥­äººå“¡'], vi: ['Tham kháº£o chuyÃªn gia'] },
                    prevention: { zh: 'é é˜²æªæ–½å¾…è£œå……', vi: 'Cáº§n bá»• sung biá»‡n phÃ¡p' }
                };
                const defectName = currentLang === 'zh' ? det.chineseName : det.vietnameseName;
                return `<div class="result-item"><div class="defect-header">
                    <div class="defect-name">${defectName}</div>
                    <span class="badge">${t('confidence')}: ${(det.score * 100).toFixed(1)}%</span></div>
                    <div class="defect-info">
                        <div class="defect-section"><div class="defect-section-title">ğŸ” ${t('defectDescription')}</div>${advice.description[currentLang]}</div>
                        <div class="defect-section"><div class="defect-section-title">âš ï¸ ${t('possibleCauses')}</div>${advice.causes[currentLang]}</div>
                        <div class="defect-section"><div class="defect-section-title">âœ… ${t('repairSuggestions')}</div>
                            ${advice.solutions[currentLang].map((s, i) => `${i + 1}. ${s}`).join('<br>')}</div>
                        <div class="defect-section"><div class="defect-section-title">ğŸ›¡ï¸ ${t('preventiveMeasures')}</div>${advice.prevention[currentLang]}</div>
                    </div></div>`;
            }).join('');
            const app = document.getElementById('app');
            app.innerHTML = `<div class="success">âœ… ${t('detectionComplete')} ${detections.length} ${t('defects')}</div>
                <div class="card"><canvas id="resultCanvas" width="${canvas.width}" height="${canvas.height}"></canvas></div>
                ${detections.length > 0 ? `<div class="card"><div class="step-title">${t('resultAndAdvice')}</div>${resultHTML}</div>` : 
                `<div class="card"><div class="success">âœ… ${t('noDefects')}</div></div>`}
                <div class="card"><button class="btn" onclick="showImageUpload()">ğŸ“· ${t('newDetection')}</button>
                <button class="btn btn-black" onclick="showPhaseSelection()" style="margin-top: 10px;">ğŸ”„ ${t('reselectStage')}</button></div>`;
            const displayCanvas = document.getElementById('resultCanvas');
            displayCanvas.getContext('2d').drawImage(canvas, 0, 0);
        }
        
        window.addEventListener('load', function() {
            console.log('ä¸Šå¥½ç‰Œæ™ºèƒ½æª¢æ¸¬ç³»çµ±å•Ÿå‹•...');
            tryLoadORT();
        });
    </script>
</body>
</html>
